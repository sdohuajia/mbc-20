#!/bin/bash

# å®‰è£…ä¾èµ–
echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
npm install

# æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸ
if [ $? -eq 0 ]; then
    echo "ä¾èµ–å®‰è£…æˆåŠŸï¼"
    
    # è·å–ç”¨æˆ·è¾“å…¥çš„åç§°
    read -p "è¯·è¾“å…¥æœºå™¨äººåç§° (ç”¨äºæ³¨å†Œ): " bot_name
    
    if [ -z "$bot_name" ]; then
        echo "åç§°ä¸èƒ½ä¸ºç©ºï¼Œæ“ä½œå·²å–æ¶ˆã€‚"
        exit 1
    fi

    echo "æ­£åœ¨é…ç½® app.js ä¸­çš„æœºå™¨äººåç§°: $bot_name ..."

    # ä½¿ç”¨ sed è‡ªåŠ¨åŒ–ä¿®æ”¹ app.js (ç¬¬ä¸€é˜¶æ®µï¼šå¼€å¯æ³¨å†Œ)
    sed -i "s/\/\/[[:space:]]*const registerResult = await register('testagentbot111122112'/const registerResult = await registerAndSave('$bot_name'/g" app.js
    sed -i "s/\/\/[[:space:]]*console.log('Moltbook æ³¨å†Œç»“æœ:', registerResult);/console.log('Moltbook æ³¨å†Œç»“æœ:', registerResult);/g" app.js

    echo "é…ç½®æ–‡ä»¶å·²æ›´æ–° (æ³¨å†Œæ¨¡å¼å·²å¼€å¯)ã€‚"

    # å¯åŠ¨ç¨‹åº (ç¬¬ä¸€é˜¶æ®µï¼šæ‰§è¡Œæ³¨å†Œ)
    echo "æ­£åœ¨å¯åŠ¨ç¨‹åº (ç¬¬ä¸€é˜¶æ®µï¼šæ³¨å†Œ)..."
    node app.js

    # æ‰§è¡Œå®Œæˆåçš„æç¤º
    echo -e "\n\033[36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "\033[36mğŸ‘‰ ç¬¬ä¸€é˜¶æ®µ (æ³¨å†Œ) å·²å®Œæˆï¼\033[0m"
    echo -e "\033[36mğŸ‘‰ è¯·ä»ä¸Šæ–¹æ—¥å¿—ä¸­æ‰¾åˆ° \033[1;33m'claim url'\033[0m \033[36må¹¶å¤åˆ¶åˆ°æµè§ˆå™¨æ‰“å¼€ã€‚\033[0m"
    echo -e "\033[36mğŸ‘‰ æŒ‰ç…§é¡µé¢æç¤ºå®Œæˆæ¨ç‰¹ï¼ˆXï¼‰å‘æ¨éªŒè¯ã€‚\033[0m"
    echo -e "\033[36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m\n"

    # ç­‰å¾…ç”¨æˆ·ç¡®è®¤
    read -p "æ‚¨æ˜¯å¦å·²å®Œæˆæ¨ç‰¹å‘æ¨éªŒè¯ï¼Ÿ(ç¡®è®¤åè¯·è¾“å…¥ y ç»§ç»­): " confirm
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        echo "æ­£åœ¨ä¸ºæ‚¨åˆ‡æ¢åˆ°å‘å¸–æ¨¡å¼..."
        
        # ä½¿ç”¨ sed è‡ªåŠ¨åŒ–è¿˜åŸ app.js (ç¬¬äºŒé˜¶æ®µï¼šå…³é—­æ³¨å†Œï¼Œå³é‡æ–°æ³¨é‡Š)
        sed -i "s/^const registerResult = await registerAndSave/\/\/ const registerResult = await registerAndSave/g" app.js
        sed -i "s/^console.log('Moltbook æ³¨å†Œç»“æœ:', registerResult);/\/\/ console.log('Moltbook æ³¨å†Œç»“æœ:', registerResult);/g" app.js
        
        echo "é…ç½®æ–‡ä»¶å·²è¿˜åŸ (æ³¨å†Œæ¨¡å¼å·²å…³é—­)ã€‚"
        
        # å¯åŠ¨ç¨‹åº (ç¬¬äºŒé˜¶æ®µï¼šæ­£å¼å‘å¸–)
        echo "æ­£åœ¨å¯åŠ¨ç¨‹åº (ç¬¬äºŒé˜¶æ®µï¼šæ­£å¼å‘å¸–)..."
        node app.js
        
        echo -e "\n\033[32mâœ… å…¨æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼\033[0m"
    else
        echo "æ“ä½œå·²ç»ˆæ­¢ã€‚æ‚¨å¯ä»¥æ‰‹åŠ¨è¿è¡Œ node app.js ç»§ç»­ã€‚"
        exit 0
    fi
else
    echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—ã€‚"
    exit 1
fi
